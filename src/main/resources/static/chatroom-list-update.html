<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .message {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        input, button {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .clear-btn {
            background-color: #6c757d;
        }
        .chatroom-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .chatroom-item.updated {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        .chatroom-time {
            color: #6c757d;
            font-size: 0.9em;
        }
        .unread-indicator {
            width: 10px;
            height: 10px;
            background-color: #007bff;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
    </style>
</head>
<body>
<h1>ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸ í…ŒìŠ¤íŠ¸</h1>

<div class="container">
    <h3>ì—°ê²° ì„¤ì •</h3>
    <div>
        <label>ì„œë²„ URL:</label>
        <input type="text" id="serverUrl" value="http://localhost:8080/ws" style="width: 200px;">
        <small style="color: #666;">â€» ì„œë²„ê°€ 8080í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”</small>
    </div>
    <div>
        <label>JWT í† í° (ì„ íƒì‚¬í•­):</label>
        <input type="text" id="jwtToken" placeholder="Bearer í† í° ì…ë ¥" style="width: 300px;">
    </div>
    <div>
        <button onclick="connect()">ì—°ê²°</button>
        <button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
    </div>
    <div id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</div>
</div>

<div class="container">
    <h3>ì½ìŒ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸</h3>
    <div>
        <label>ì±„íŒ…ë°© ID:</label>
        <input type="number" id="readChatRoomId" placeholder="ì½ìŒ ì²˜ë¦¬í•  ì±„íŒ…ë°© ID" style="width: 150px;">
        <button onclick="markAsRead()">ì½ìŒ ì²˜ë¦¬</button>
    </div>
    <p style="font-size: 0.9em; color: #666;">
        ğŸ’¡ ì±„íŒ…ë°©ì— ë“¤ì–´ê°”ì„ ë•Œë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤. ì½ìŒ ì²˜ë¦¬ í›„ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ëª©ë¡ì—ì„œ ì½ì§€ì•Šì€ë©”ì‹œì§€ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
    </p>
</div>

<div class="container">
    <h3>ì±„íŒ…ë°© ëª©ë¡ ì‹œë®¬ë ˆì´ì…˜</h3>
    <button onclick="loadInitialChatRooms()">ì´ˆê¸° ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ</button>
    <button onclick="clearChatRooms()" class="clear-btn">ëª©ë¡ ì´ˆê¸°í™”</button>
    <div id="chatRoomList" style="border: 1px solid #ddd; padding: 10px; margin: 10px 0; min-height: 200px;">
        <p style="color: #666;">ì±„íŒ…ë°© ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
</div>

<div class="container">
    <h3>ìˆ˜ì‹ ëœ ë©”ì‹œì§€</h3>
    <button onclick="clearMessages()" class="clear-btn">ë©”ì‹œì§€ ì§€ìš°ê¸°</button>
    <div id="messages"></div>
</div>

<div class="container">
    <h3>ì‚¬ìš© ë°©ë²•</h3>
    <ol>
        <li>JWT í† í°ì„ ì…ë ¥í•˜ê³  "ì—°ê²°" ë²„íŠ¼ í´ë¦­</li>
        <li>"ì´ˆê¸° ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ" í´ë¦­í•˜ì—¬ ê¸°ì¡´ ì±„íŒ…ë°©ë“¤ í™•ì¸</li>
        <li>Postmanì—ì„œ ë‹¤ë¥¸ ì‚¬ìš©ìë¡œ <code>/api/dm/send-message</code> í˜¸ì¶œ</li>
        <li>ì‹¤ì‹œê°„ìœ¼ë¡œ ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸ ë° ì •ë ¬ í™•ì¸</li>
    </ol>
    <p><strong>ì£¼ì˜:</strong> ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ì‚¬ìš©ìì™€ ë°›ëŠ” ì‚¬ìš©ìê°€ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.</p>
</div>

<!-- SockJSì™€ STOMP ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>

<script>
    let stompClient = null;
    let socket = null;
    let chatRooms = []; // ì±„íŒ…ë°© ëª©ë¡ ì €ì¥

    function setConnected(connected) {
        const status = document.getElementById('connectionStatus');
        if (connected) {
            status.textContent = 'âœ… WebSocket ì—°ê²°ë¨';
            status.className = 'status connected';
        } else {
            status.textContent = 'âŒ WebSocket ì—°ê²° ì•ˆë¨';
            status.className = 'status disconnected';
        }
    }

    function loadInitialChatRooms() {
        const jwtToken = document.getElementById('jwtToken').value;

        if (!jwtToken || !jwtToken.trim()) {
            addMessage('âŒ JWT í† í°ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        const token = jwtToken.startsWith('Bearer ') ? jwtToken : 'Bearer ' + jwtToken;

        addMessage('ğŸ“¡ ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

        fetch('/api/dm/rooms/participated', {
            method: 'GET',
            headers: {
                'Authorization': token,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('API ì‘ë‹µ:', data);

                // API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ chatRooms ë°°ì—´ ì„¤ì •
                if (Array.isArray(data)) {
                    chatRooms = data;
                } else if (data.data && Array.isArray(data.data)) {
                    chatRooms = data.data;
                } else {
                    throw new Error('ì˜ˆìƒì¹˜ ëª»í•œ API ì‘ë‹µ êµ¬ì¡°');
                }

                renderChatRoomList();
                addMessage(`âœ… ì‹¤ì œ ì±„íŒ…ë°© ëª©ë¡ì„ ë¡œë“œí–ˆìŠµë‹ˆë‹¤ (${chatRooms.length}ê°œ)`);
            })
            .catch(error => {
                console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
                addMessage(`âŒ ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
            });
    }

    function renderChatRoomList() {
        const listDiv = document.getElementById('chatRoomList');

        if (!chatRooms || chatRooms.length === 0) {
            listDiv.innerHTML = '<p style="color: #666;">ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ë©”ì‹œì§€ê°€ ìœ„ë¡œ)
        const sortedRooms = [...chatRooms].sort((a, b) => {
            const timeA = new Date(a.lastMessageTime || a.updatedAt || 0);
            const timeB = new Date(b.lastMessageTime || b.updatedAt || 0);
            return timeB - timeA;
        });

        listDiv.innerHTML = sortedRooms.map(room => {
            // API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ë°ì´í„° ì¶”ì¶œ
            let displayName, chatRoomId, lastMessage, lastMessageTime, hasUnreadMessages;

            if (room.dmChatRoomId) {
                // DM ì±„íŒ…ë°©
                chatRoomId = room.dmChatRoomId;
                displayName = room.otherUser?.nickname || room.otherUserName || 'ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ìš©ì';
                lastMessage = room.lastMessage || 'ë©”ì‹œì§€ ì—†ìŒ';
                lastMessageTime = room.lastMessageTime || room.updatedAt;
                hasUnreadMessages = room.hasUnreadMessages || false;
            } else if (room.groupChatRoomId) {
                // ê·¸ë£¹ ì±„íŒ…ë°©
                chatRoomId = room.groupChatRoomId;
                displayName = room.meeting?.meetingTitle || room.meetingTitle || 'ì•Œ ìˆ˜ ì—†ëŠ” ëª¨ì„';
                lastMessage = room.lastMessage || 'ë©”ì‹œì§€ ì—†ìŒ';
                lastMessageTime = room.lastMessageTime || room.updatedAt;
                hasUnreadMessages = room.hasUnreadMessages || false;
            } else {
                // ê¸°ë³¸ê°’
                chatRoomId = room.chatRoomId || room.id;
                displayName = room.name || 'ì±„íŒ…ë°©';
                lastMessage = room.lastMessage || 'ë©”ì‹œì§€ ì—†ìŒ';
                lastMessageTime = room.lastMessageTime || room.updatedAt;
                hasUnreadMessages = room.hasUnreadMessages || false;
            }

            const unreadIndicator = hasUnreadMessages
                ? '<span class="unread-indicator"></span>'
                : '';

            const timeStr = lastMessageTime
                ? new Date(lastMessageTime).toLocaleString()
                : 'ì‹œê°„ ì—†ìŒ';

            return `
                    <div class="chatroom-item" data-room-id="${chatRoomId}">
                        <strong>${displayName}</strong> ${unreadIndicator}
                        <div style="font-size: 0.9em; color: #666;">${lastMessage}</div>
                        <div class="chatroom-time">${timeStr}</div>
                        <div style="font-size: 0.8em; color: #999;">ID: ${chatRoomId}</div>
                    </div>
                `;
        }).join('');
    }

    function updateChatRoomList(updateData) {
        console.log('ğŸ”„ updateChatRoomList í˜¸ì¶œë¨:', updateData);

        // ê¸°ì¡´ ì±„íŒ…ë°© ì°¾ê¸° (dmChatRoomId ë˜ëŠ” chatRoomIdë¡œ ì°¾ê¸°)
        const roomId = updateData.dmChatRoomId || updateData.chatRoomId;
        const existingIndex = chatRooms.findIndex(room =>
            (room.dmChatRoomId && room.dmChatRoomId === roomId) ||
            (room.groupChatRoomId && room.groupChatRoomId === roomId) ||
            (room.chatRoomId && room.chatRoomId === roomId)
        );

        console.log(`ğŸ” ì±„íŒ…ë°© ${roomId} ì°¾ê¸° ê²°ê³¼:`, existingIndex !== -1 ? 'ì°¾ìŒ' : 'ëª»ì°¾ìŒ');

        if (existingIndex !== -1) {
            console.log('ğŸ“ ì—…ë°ì´íŠ¸ ì „:', JSON.stringify(chatRooms[existingIndex]));

            // ê¸°ì¡´ ì±„íŒ…ë°© ì—…ë°ì´íŠ¸
            chatRooms[existingIndex] = { ...chatRooms[existingIndex], ...updateData };

            console.log('ğŸ“ ì—…ë°ì´íŠ¸ í›„:', JSON.stringify(chatRooms[existingIndex]));
            addMessage(`ğŸ”„ ê¸°ì¡´ ì±„íŒ…ë°© ${roomId} ì—…ë°ì´íŠ¸ë¨`);
        } else {
            // ìƒˆ ì±„íŒ…ë°© ì¶”ê°€
            chatRooms.push(updateData);
            addMessage(`â• ìƒˆ ì±„íŒ…ë°© ${roomId} ì¶”ê°€ë¨`);
        }

        // ëª©ë¡ ë‹¤ì‹œ ë Œë”ë§
        console.log('ğŸ¨ ë Œë”ë§ ì‹œì‘...');
        renderChatRoomList();

        // ì—…ë°ì´íŠ¸ëœ ì±„íŒ…ë°© í•˜ì´ë¼ì´íŠ¸
        setTimeout(() => {
            const updatedRoom = document.querySelector(`[data-room-id="${roomId}"]`);
            if (updatedRoom) {
                updatedRoom.classList.add('updated');
                setTimeout(() => updatedRoom.classList.remove('updated'), 2000);
            }
        }, 100);

        addMessage(`ğŸ“ˆ ì±„íŒ…ë°© ëª©ë¡ ì¬ì •ë ¬ë¨ - ì±„íŒ…ë°© ${roomId}ì´ ë§¨ ìœ„ë¡œ ì´ë™`);
    }

    function markAsRead() {
        const chatRoomId = document.getElementById('readChatRoomId').value;
        const jwtToken = document.getElementById('jwtToken').value;

        if (!chatRoomId || !chatRoomId.trim()) {
            addMessage('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        if (!jwtToken || !jwtToken.trim()) {
            addMessage('âŒ JWT í† í°ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        const token = jwtToken.startsWith('Bearer ') ? jwtToken : 'Bearer ' + jwtToken;

        addMessage(`ğŸ“– ì±„íŒ…ë°© ${chatRoomId} ì½ìŒ ì²˜ë¦¬ API í˜¸ì¶œ ì¤‘...`);
        console.log(`ğŸ” ì½ìŒ ì²˜ë¦¬ ì „ í˜„ì¬ ìƒíƒœ:`, chatRooms.find(room => room.dmChatRoomId == chatRoomId));

        // API í˜¸ì¶œ
        fetch(`/api/dm/${chatRoomId}/all-messages`, {
            method: 'PUT',
            headers: {
                'Authorization': token,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ğŸ“– ì½ìŒ ì²˜ë¦¬ API ì‘ë‹µ:', data);
                addMessage(`âœ… ì±„íŒ…ë°© ${chatRoomId} ì½ìŒ ì²˜ë¦¬ API ì„±ê³µ`);
                addMessage(`ğŸ’¡ ì´ì œ WebSocket ë©”ì‹œì§€ê°€ ì™€ì•¼ í•©ë‹ˆë‹¤...`);

                // 5ì´ˆ í›„ì—ë„ ì—…ë°ì´íŠ¸ ì•ˆë˜ë©´ ê²½ê³ 
                setTimeout(() => {
                    const updatedRoom = chatRooms.find(room => room.dmChatRoomId == chatRoomId);
                    if (updatedRoom && updatedRoom.hasUnreadMessages) {
                        addMessage(`âš ï¸ 5ì´ˆ ê²½ê³¼í–ˆì§€ë§Œ ì•„ì§ ì½ìŒ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ`);
                    }
                }, 5000);
            })
            .catch(error => {
                console.error('ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                addMessage(`âŒ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);
            });
    }

    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        const jwtToken = document.getElementById('jwtToken').value;

        // JWT í† í°ì„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
        let wsUrl = serverUrl;
        if (jwtToken && jwtToken.trim()) {
            const token = jwtToken.startsWith('Bearer ') ? jwtToken.substring(7) : jwtToken;
            wsUrl += `?token=${encodeURIComponent(token)}`;
        }

        console.log('ì—°ê²° ì‹œë„:', wsUrl);

        // SockJS ì—°ê²° (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ì— í† í° í¬í•¨)
        socket = new SockJS(wsUrl);
        stompClient = new StompJs.Client({
            webSocketFactory: () => socket,
            debug: function (str) {
                console.log('STOMP Debug:', str);
            },
            reconnectDelay: 5000,
            heartbeatIncoming: 4000,
            heartbeatOutgoing: 4000,
            // STOMP ì—°ê²° í—¤ë” ì„¤ì •
            connectHeaders: jwtToken && jwtToken.trim() ? {
                'Authorization': jwtToken.startsWith('Bearer ') ? jwtToken : 'Bearer ' + jwtToken
            } : {}
        });

        stompClient.onConnect = function (frame) {
            console.log('Connected:', frame);
            setConnected(true);

            // ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸ êµ¬ë…
            stompClient.subscribe('/user/queue/chatroom-list-update', function (message) {
                console.log('ğŸ“© RAW ë°›ì€ ë©”ì‹œì§€:', message);
                console.log('ğŸ“© ë©”ì‹œì§€ ë°”ë””:', message.body);

                // ì½ìŒ ì²˜ë¦¬ í›„ ë°›ì€ ë©”ì‹œì§€ì¸ì§€ í™•ì¸
                const data = JSON.parse(message.body);
                console.log('ğŸ“© íŒŒì‹±ëœ ë°ì´í„°:', data);
                console.log('ğŸ“© hasUnreadMessages:', data.hasUnreadMessages);

                showMessage(message.body);
            });

            addMessage('âœ… WebSocket ì—°ê²° ì„±ê³µ ë° êµ¬ë… ì™„ë£Œ');
        };

        // STOMP ì—°ê²° í—¤ë” ì„¤ì •
        const connectHeaders = {};
        if (jwtToken && jwtToken.trim()) {
            const token = jwtToken.startsWith('Bearer ') ? jwtToken : 'Bearer ' + jwtToken;
            connectHeaders['Authorization'] = token;
        }

        stompClient.onStompError = function (frame) {
            console.error('STOMP Error:', frame);
            setConnected(false);
            addMessage('âŒ STOMP ì—ëŸ¬: ' + frame.headers['message']);
        };

        stompClient.onWebSocketError = function (event) {
            console.error('WebSocket Error:', event);
            setConnected(false);
            addMessage('âŒ WebSocket ì—ëŸ¬: ' + event);
        };

        stompClient.onDisconnect = function () {
            console.log('Disconnected');
            setConnected(false);
            addMessage('ğŸ”Œ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
        };

        // ì—°ê²° ì‹œì‘
        stompClient.activate();
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.deactivate();
            console.log('Disconnected');
            setConnected(false);
            addMessage('ğŸ”Œ ì—°ê²°ì„ í•´ì œí–ˆìŠµë‹ˆë‹¤');
        }
    }

    function showMessage(messageBody) {
        try {
            const data = JSON.parse(messageBody);

            // ë””ë²„ê¹…ìš©: ì–´ë–¤ ì¢…ë¥˜ì˜ ì—…ë°ì´íŠ¸ì¸ì§€ í™•ì¸
            const updateType = data.lastMessageTime && data.lastMessage ? "ë©”ì‹œì§€ì „ì†¡" : "ì½ìŒì²˜ë¦¬";
            console.log(`ğŸ“© ì—…ë°ì´íŠ¸ íƒ€ì…: ${updateType}`, data);

            // ì±„íŒ…ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
            updateChatRoomList(data);

            const formattedMessage = `ğŸ“© ì±„íŒ…ë°© ì—…ë°ì´íŠ¸ ë°›ìŒ (${updateType}):
ì±„íŒ…ë°© ID: ${data.dmChatRoomId || data.chatRoomId}
íƒ€ì…: ${data.chatRoomType || 'DM'}
${data.chatRoomType === 'DM' ? `ìƒëŒ€ë°©: ${data.otherUser?.nickname}` : `ëª¨ì„: ${data.meeting?.meetingTitle}`}
ë§ˆì§€ë§‰ ë©”ì‹œì§€: ${data.lastMessage || 'ì—†ìŒ'}
ì‹œê°„: ${data.lastMessageTime || 'ì—†ìŒ'}
ì½ì§€ì•Šì€ë©”ì‹œì§€: ${data.hasUnreadMessages}
`;
            addMessage(formattedMessage);
        } catch (e) {
            addMessage('ğŸ“© ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨: ' + messageBody);
        }
    }

    function addMessage(message) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.textContent = new Date().toLocaleTimeString() + ' - ' + message;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
        document.getElementById('messages').innerHTML = '';
    }

    // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ
    window.addEventListener('load', function() {
        setConnected(false);
        addMessage('ğŸ’¡ í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ì—°ê²° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
    });

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', function() {
        if (stompClient !== null) {
            stompClient.deactivate();
        }
    });
</script>
</body>
</html>