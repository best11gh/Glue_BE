<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¸ë£¹ ì±„íŒ… í…ŒìŠ¤íŠ¸ (ë„¤ì´í‹°ë¸Œ WebSocket)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .user-panel {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-width: 32%;
        }
        .user-header {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            text-align: center;
            position: relative;
        }
        .message-list {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }
        .message {
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            max-width: 70%;
            word-break: break-word;
        }
        .sent {
            background-color: #DCF8C6;
            margin-left: auto;
            text-align: right;
        }
        .received {
            background-color: #ECECEC;
        }
        .message-input {
            width: 100%;
            display: flex;
            margin-top: 10px;
        }
        .message-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .message-input button {
            padding: 10px 15px;
            margin-left: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .connected {
            background-color: #DFF2BF;
            color: #4F8A10;
        }
        .disconnected {
            background-color: #FFBABA;
            color: #D8000C;
        }
        .message-meta {
            font-size: 0.8em;
            color: #888;
            margin-top: 4px;
        }
        .chat-controls {
            margin-top: 10px;
            text-align: center;
        }
        .read-count {
            font-size: 0.8em;
            color: #888;
        }
        .read-all-btn {
            padding: 8px 16px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .token-display {
            font-size: 0.7em;
            color: #888;
            margin-top: 5px;
            word-break: break-all;
        }
        .logs {
            margin-top: 20px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f5f5f5;
            font-family: monospace;
            font-size: 12px;
        }
        .user-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .user-controls button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .connect-btn {
            background-color: #4CAF50;
            color: white;
        }
        .disconnect-btn {
            background-color: #f44336;
            color: white;
        }
        .websocket-type {
            background-color: #e7f3ff;
            color: #0066cc;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="header">
    <h1>ê·¸ë£¹ ì±„íŒ… í…ŒìŠ¤íŠ¸ (ë„¤ì´í‹°ë¸Œ WebSocket)</h1>
    <div class="websocket-type">
        <strong>ğŸ”§ ë³€ê²½ì‚¬í•­:</strong> SockJSì™€ STOMP.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì œê±°í•˜ê³  ë„¤ì´í‹°ë¸Œ WebSocket APIë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </div>
    <p>ì±„íŒ…ë°© ID: 1 | ì—”ë“œí¬ì¸íŠ¸: ë©”ì‹œì§€ ì „ì†¡(/api/group/{groupChatroomId}/send-message), ì½ìŒì²˜ë¦¬(/app/group/{groupChatRoomId}/read-message), ë©”ì‹œì§€ ëª©ë¡(/api/group/{groupChatroomId}/messages)</p>
    <p style="color: #721c24; background-color: #f8d7da; padding: 10px; border-radius: 5px;">SQLite ë½ ì˜¤ë¥˜ ì£¼ì˜: ë™ì‹œì— ì—¬ëŸ¬ ì‚¬ìš©ìë¥¼ ì—°ê²°í•˜ë©´ ë°ì´í„°ë² ì´ìŠ¤ ë½ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•œ ë²ˆì— í•œ ì‚¬ìš©ìë§Œ ì—°ê²°í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
</div>

<div class="container">
    <!-- ì‚¬ìš©ì 1 íŒ¨ë„ -->
    <div class="user-panel" id="user-panel-1">
        <div class="user-header">
            <strong>ì‚¬ìš©ì 1</strong>
            <span class="connection-status disconnected" id="connection-status-1">ì—°ê²° ëŒ€ê¸° ì¤‘</span>
            <div id="token-display-1" class="token-display"></div>
        </div>

        <div class="user-controls">
            <button class="connect-btn" id="connect-btn-1" onclick="connect(1)">ì—°ê²°í•˜ê¸°</button>
            <button class="disconnect-btn" id="disconnect-btn-1" onclick="disconnect(1)" disabled>ì—°ê²° ëŠê¸°</button>
        </div>

        <div class="message-list" id="message-list-1">
            <div class="alert" style="text-align: center; padding: 10px; color: #856404; background-color: #fff3cd; border-radius: 5px;">
                ë„¤ì´í‹°ë¸Œ WebSocketìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤. ê° íŒ¨ë„ì„ ìˆœì°¨ì ìœ¼ë¡œ ì—°ê²°í•˜ì„¸ìš”.
            </div>
        </div>

        <button class="read-all-btn" id="read-all-btn-1" onclick="markAllAsRead(1)">ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬</button>

        <div class="message-input">
            <input type="text" id="message-input-1" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeyup="handleKeyPress(event, 1)">
            <button onclick="sendMessage(1)">ì „ì†¡</button>
        </div>
    </div>

    <!-- ì‚¬ìš©ì 2 íŒ¨ë„ -->
    <div class="user-panel" id="user-panel-2">
        <div class="user-header">
            <strong>ì‚¬ìš©ì 2</strong>
            <span class="connection-status disconnected" id="connection-status-2">ì—°ê²° ëŒ€ê¸° ì¤‘</span>
            <div id="token-display-2" class="token-display"></div>
        </div>

        <div class="user-controls">
            <button class="connect-btn" id="connect-btn-2" onclick="connect(2)">ì—°ê²°í•˜ê¸°</button>
            <button class="disconnect-btn" id="disconnect-btn-2" onclick="disconnect(2)" disabled>ì—°ê²° ëŠê¸°</button>
        </div>

        <div class="message-list" id="message-list-2">
            <div class="alert" style="text-align: center; padding: 10px; color: #856404; background-color: #fff3cd; border-radius: 5px;">
                ë„¤ì´í‹°ë¸Œ WebSocketìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤. ê° íŒ¨ë„ì„ ìˆœì°¨ì ìœ¼ë¡œ ì—°ê²°í•˜ì„¸ìš”.
            </div>
        </div>

        <button class="read-all-btn" id="read-all-btn-2" onclick="markAllAsRead(2)">ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬</button>

        <div class="message-input">
            <input type="text" id="message-input-2" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeyup="handleKeyPress(event, 2)">
            <button onclick="sendMessage(2)">ì „ì†¡</button>
        </div>
    </div>

    <!-- ì‚¬ìš©ì 3 íŒ¨ë„ -->
    <div class="user-panel" id="user-panel-3">
        <div class="user-header">
            <strong>ì‚¬ìš©ì 3</strong>
            <span class="connection-status disconnected" id="connection-status-3">ì—°ê²° ëŒ€ê¸° ì¤‘</span>
            <div id="token-display-3" class="token-display"></div>
        </div>

        <div class="user-controls">
            <button class="connect-btn" id="connect-btn-3" onclick="connect(3)">ì—°ê²°í•˜ê¸°</button>
            <button class="disconnect-btn" id="disconnect-btn-3" onclick="disconnect(3)" disabled>ì—°ê²° ëŠê¸°</button>
        </div>

        <div class="message-list" id="message-list-3">
            <div class="alert" style="text-align: center; padding: 10px; color: #856404; background-color: #fff3cd; border-radius: 5px;">
                ë„¤ì´í‹°ë¸Œ WebSocketìœ¼ë¡œ ì—°ê²°ë©ë‹ˆë‹¤. ê° íŒ¨ë„ì„ ìˆœì°¨ì ìœ¼ë¡œ ì—°ê²°í•˜ì„¸ìš”.
            </div>
        </div>

        <button class="read-all-btn" id="read-all-btn-3" onclick="markAllAsRead(3)">ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬</button>

        <div class="message-input">
            <input type="text" id="message-input-3" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeyup="handleKeyPress(event, 3)">
            <button onclick="sendMessage(3)">ì „ì†¡</button>
        </div>
    </div>
</div>

<div class="logs" id="logs">
    <div>ë¡œê·¸ ê¸°ë¡... (ë„¤ì´í‹°ë¸Œ WebSocket ì‚¬ìš©)</div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    const groupChatroomId = 1;
    const webSockets = {};
    const messagesPerUser = {
        1: [],
        2: [],
        3: []
    };

    // ì‚¬ìš©ì ì •ë³´
    const users = {
        1: { userId: 1, nickname: "ì‚¬ìš©ì 1", profileImage: null, token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJpYXQiOjE3NDg5NDcxNTcsImV4cCI6MTc1NzU4NzE1NywibWVtYmVySWQiOjEsIm1lbWJlck5pY2tuYW1lIjoi6rmA66-87IiYIiwibWVtYmVyUm9sZSI6IlJPTEVfVVNFUiJ9.Qiclk_eBFJwWhrINtwCKPbNqz_-Qtg96bCa6LwsxslroGE2PY6p7hjcWVs0lwQJiYsTBTZmeGaT_YAtyTN6ILQ" },
        2: { userId: 1, nickname: "ì‚¬ìš©ì 2", profileImage: null, token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJpYXQiOjE3NDg5NDcxNTcsImV4cCI6MTc1NzU4NzE1NywibWVtYmVySWQiOjIsIm1lbWJlck5pY2tuYW1lIjoi7IKs6528IiwibWVtYmVyUm9sZSI6IlJPTEVfVVNFUiJ9.JJOTPUa3gUouyQ3na7m8rZDm2oSPUr81DNVZP3IODc0h5G5vvUdkQZLYfIdnw3FqAVHuSYrHixDYi8xC3QQoBQ" },
        3: { userId: 1, nickname: "ì‚¬ìš©ì 3", profileImage: null, token: "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzUxMiJ9.eyJpYXQiOjE3NDg5NDcxNTcsImV4cCI6MTc1NzU4NzE1NywibWVtYmVySWQiOjQsIm1lbWJlck5pY2tuYW1lIjoi66as64KYIiwibWVtYmVyUm9sZSI6IlJPTEVfVVNFUiJ9.aeSHZz-cVmbVa1pbAINi-v2cp7tNKZdG1Otelnnr6vZPOqt27yD4bA5qgExBeqWK-WIX9DnVRq7nJ_6Hp3xLQw" }
    };

    // ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
    function addLog(message) {
        const logs = document.getElementById('logs');
        const logEntry = document.createElement('div');
        logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        logs.appendChild(logEntry);
        logs.scrollTop = logs.scrollHeight;
    }

    // ê° ì‚¬ìš©ì íŒ¨ë„ ì´ˆê¸°í™”
    function initializeUserPanels() {
        for (let userId = 1; userId <= 3; userId++) {
            // í† í° ì •ë³´ í‘œì‹œ (ì¼ë¶€ë§Œ)
            const tokenDisplay = document.getElementById(`token-display-${userId}`);
            const token = users[userId].token;
            const shortToken = token.substring(0, 10) + '...' + token.substring(token.length - 10);
            tokenDisplay.textContent = `í† í°: ${shortToken}`;
        }

        // ëª¨ë“  ì‚¬ìš©ìì— ëŒ€í•´ ë©”ì‹œì§€ ë¡œë“œ
        loadAllMessagesForAllUsers();
    }

    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateConnectionStatus(userId, isConnected) {
        const statusElement = document.getElementById(`connection-status-${userId}`);

        if (isConnected) {
            statusElement.textContent = `ì—°ê²°ë¨ (ë„¤ì´í‹°ë¸Œ WS)`;
            statusElement.classList.remove('disconnected');
            statusElement.classList.add('connected');

            document.getElementById(`connect-btn-${userId}`).disabled = true;
            document.getElementById(`disconnect-btn-${userId}`).disabled = false;
        } else {
            statusElement.textContent = 'ì—°ê²° ëŒ€ê¸° ì¤‘';
            statusElement.classList.remove('connected');
            statusElement.classList.add('disconnected');

            document.getElementById(`connect-btn-${userId}`).disabled = false;
            document.getElementById(`disconnect-btn-${userId}`).disabled = true;
        }
    }

    // WebSocket ì—°ê²° í•¨ìˆ˜ (ë„¤ì´í‹°ë¸Œ WebSocket ì‚¬ìš©)
    function connect(userId) {
        if (webSockets[userId]) {
            addLog(`ì‚¬ìš©ì ${userId}ëŠ” ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
            return;
        }

        // SQLite ë½ ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ê²½ê³ 
        const connectedUsers = Object.keys(webSockets).filter(id => webSockets[id] !== null).length;
        if (connectedUsers > 0) {
            const proceed = confirm("SQLite ë½ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (!proceed) return;
        }

        // WebSocket URL ìƒì„± (STOMP ì—”ë“œí¬ì¸íŠ¸ê°€ ì•„ë‹Œ ì¼ë°˜ WebSocket ì—”ë“œí¬ì¸íŠ¸)
        // ì‹¤ì œ ì„œë²„ì—ì„œëŠ” /ws-native ê°™ì€ ë³„ë„ ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ì–´ì•¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws?token=${users[userId].token}`;

        addLog(`ì‚¬ìš©ì ${userId}: WebSocket ì—°ê²° ì‹œë„ - ${wsUrl}`);

        try {
            webSockets[userId] = new WebSocket(wsUrl);

            webSockets[userId].onopen = function(event) {
                addLog(`ì‚¬ìš©ì ${userId}: ë„¤ì´í‹°ë¸Œ WebSocket ì—°ê²° ì„±ê³µ`);
                updateConnectionStatus(userId, true);

                // ì—°ê²° í›„ ì±„íŒ…ë°© êµ¬ë… ìš”ì²­
                const subscribeMessage = {
                    type: 'SUBSCRIBE',
                    groupChatroomId: groupChatroomId,
                    userId: userId
                };
                webSockets[userId].send(JSON.stringify(subscribeMessage));

                // ì—°ê²° í›„ ë©”ì‹œì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                setTimeout(() => loadMessages(userId), 300);
            };

            webSockets[userId].onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    onMessageReceived(userId, message);
                } catch (error) {
                    addLog(`ì‚¬ìš©ì ${userId}: ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜: ${error.message}`);
                }
            };

            webSockets[userId].onclose = function(event) {
                addLog(`ì‚¬ìš©ì ${userId}: WebSocket ì—°ê²° í•´ì œ (code: ${event.code}, reason: ${event.reason})`);
                updateConnectionStatus(userId, false);
                webSockets[userId] = null;
            };

            webSockets[userId].onerror = function(error) {
                addLog(`ì‚¬ìš©ì ${userId}: WebSocket ì˜¤ë¥˜: ${error}`);
                updateConnectionStatus(userId, false);
                webSockets[userId] = null;
            };

        } catch (error) {
            addLog(`ì‚¬ìš©ì ${userId}: WebSocket ìƒì„± ì˜¤ë¥˜: ${error.message}`);
            updateConnectionStatus(userId, false);
        }
    }

    // ì—°ê²° í•´ì œ í•¨ìˆ˜
    function disconnect(userId) {
        if (webSockets[userId]) {
            webSockets[userId].close();
            webSockets[userId] = null;
            addLog(`ì‚¬ìš©ì ${userId}: WebSocket ì—°ê²° í•´ì œ`);
            updateConnectionStatus(userId, false);
        }
    }

    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (REST API ì‚¬ìš© - ë³€ê²½ ì—†ìŒ)
    function sendMessage(userId) {
        if (!webSockets[userId]) {
            alert(`ì‚¬ìš©ì ${userId}ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
            return;
        }

        const messageInput = document.getElementById(`message-input-${userId}`);
        const content = messageInput.value.trim();

        if (content === '') {
            return;
        }

        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        messageInput.value = '';

        // REST APIë¡œ ë©”ì‹œì§€ ì „ì†¡ ìš”ì²­
        fetch(`/api/group/${groupChatroomId}/send-message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${users[userId].token}`
            },
            body: JSON.stringify({
                content: content
            })
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨');
                }
                return response.json();
            })
            .then(data => {
                addLog(`ì‚¬ìš©ì ${userId}: ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ: ${content}`);
            })
            .catch(error => {
                addLog(`ì‚¬ìš©ì ${userId}: ì˜¤ë¥˜: ${error.message}`);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë©”ì‹œì§€ ì…ë ¥ì°½ì— í…ìŠ¤íŠ¸ ë³µì›
                messageInput.value = content;
            });
    }

    // ì—”í„° í‚¤ ì²˜ë¦¬ í•¨ìˆ˜
    function handleKeyPress(event, userId) {
        if (event.key === 'Enter') {
            sendMessage(userId);
        }
    }

    // ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬ í•¨ìˆ˜ (ë„¤ì´í‹°ë¸Œ WebSocketìš©)
    function onMessageReceived(userId, message) {
        addLog(`ì‚¬ìš©ì ${userId}: ë©”ì‹œì§€ ìˆ˜ì‹ : ${JSON.stringify(message)}`);

        // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ì²˜ë¦¬
        if (message.type === 'GROUP_MESSAGE') {
            // ëª¨ë“  ì—°ê²°ëœ ì‚¬ìš©ìì˜ UIì— ë©”ì‹œì§€ ì¶”ê°€
            for (let id = 1; id <= 3; id++) {
                if (webSockets[id]) {
                    addMessageToUI(id, message.data);
                }
            }
        } else if (message.type === 'READ_STATUS_UPDATE') {
            // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸
            for (let id = 1; id <= 3; id++) {
                if (webSockets[id]) {
                    updateMessagesReadStatus(id, message.data);
                }
            }
        }
    }

    // ë©”ì‹œì§€ UIì— ì¶”ê°€ í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
    function addMessageToUI(userId, message) {
        // í•´ë‹¹ ì‚¬ìš©ìì˜ ë©”ì‹œì§€ ë°°ì—´ì— ì¶”ê°€
        if (!messagesPerUser[userId].some(m => m.groupMessageId === message.groupMessageId)) {
            messagesPerUser[userId].push(message);
        }

        const messageList = document.getElementById(`message-list-${userId}`);

        // ì´ë¯¸ UIì— í•´ë‹¹ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
        const existingMessage = document.querySelector(`#message-list-${userId} .message[data-message-id="${message.groupMessageId}"]`);
        if (existingMessage) {
            return; // ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
        }

        const messageElement = document.createElement('div');

        // ë°œì‹ ìê°€ í˜„ì¬ ì‚¬ìš©ìì¸ì§€ í™•ì¸
        const isSentByCurrentUser = message.sender.userId === userId;

        messageElement.classList.add('message');
        messageElement.classList.add(isSentByCurrentUser ? 'sent' : 'received');
        messageElement.dataset.messageId = message.groupMessageId;

        // ë©”ì‹œì§€ ë‚´ìš©
        messageElement.innerHTML = `
            ${!isSentByCurrentUser ? `<strong>${message.sender.nickname}</strong><br>` : ''}
            ${message.content}
            <div class="message-meta">
                ${new Date(message.sendTime).toLocaleTimeString()}
                ${isSentByCurrentUser ? `<span class="read-count">ì½ì§€ ì•ŠìŒ: ${message.unreadCount}</span>` : ''}
            </div>
        `;

        messageList.appendChild(messageElement);
        messageList.scrollTop = messageList.scrollHeight;
    }

    // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
    function updateMessagesReadStatus(userId, readStatus) {
        readStatus.updatedMessages.forEach(updatedMessage => {
            const messageElements = document.querySelectorAll(`#message-list-${userId} .message[data-message-id="${updatedMessage.groupMessageId}"]`);

            messageElements.forEach(element => {
                const metaElement = element.querySelector('.message-meta');
                if (metaElement) {
                    const readCountElement = metaElement.querySelector('.read-count');
                    if (readCountElement) {
                        readCountElement.textContent = `ì½ì§€ ì•ŠìŒ: ${updatedMessage.unreadCount}`;
                    }
                }
            });

            const messageIndex = messagesPerUser[userId].findIndex(m => m.groupMessageId === updatedMessage.groupMessageId);
            if (messageIndex !== -1) {
                messagesPerUser[userId][messageIndex].unreadCount = updatedMessage.unreadCount;
            }
        });
    }

    // ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ í•¨ìˆ˜ (WebSocket ë©”ì‹œì§€ë¡œ ë³€ê²½)
    function markAllAsRead(userId) {
        if (!webSockets[userId]) {
            alert(`ì‚¬ìš©ì ${userId}ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
            return;
        }

        // WebSocketì„ í†µí•´ ì½ìŒ ì²˜ë¦¬ ìš”ì²­ ì „ì†¡
        const readMessage = {
            type: 'MARK_AS_READ',
            groupChatroomId: groupChatroomId,
            receiverId: userId
        };

        webSockets[userId].send(JSON.stringify(readMessage));
        addLog(`ì‚¬ìš©ì ${userId}: ëª¨ë“  ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ìš”ì²­ ì „ì†¡`);
    }

    // ëª¨ë“  ì‚¬ìš©ìì— ëŒ€í•´ ë©”ì‹œì§€ ë¡œë“œ
    function loadAllMessagesForAllUsers() {
        for (let userId = 1; userId <= 3; userId++) {
            document.getElementById(`token-display-${userId}`).textContent =
                `í† í°: ${users[userId].token.substring(0, 10)}...${users[userId].token.substring(users[userId].token.length - 10)}`;
        }
        addLog("ëª¨ë“  íŒ¨ë„ ì´ˆê¸°í™” ì™„ë£Œ. ê° ì‚¬ìš©ìë¥¼ ê°œë³„ì ìœ¼ë¡œ ì—°ê²°í•˜ì„¸ìš”.");
    }

    // ë©”ì‹œì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
    function loadMessages(userId, updateUI = true) {
        fetch(`/api/group/${groupChatroomId}/all-messages`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${users[userId].token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë©”ì‹œì§€ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                }
                return response.json();
            })
            .then(data => {
                addLog(`ì‚¬ìš©ì ${userId}: ë©”ì‹œì§€ ëª©ë¡ ë¡œë“œ ì„±ê³µ`);

                if (updateUI) {
                    document.getElementById(`message-list-${userId}`).innerHTML = '';
                    messagesPerUser[userId] = [];
                }

                if (Array.isArray(data)) {
                    data.forEach(message => {
                        if (updateUI) {
                            addMessageToUI(userId, message);
                        } else {
                            if (!messagesPerUser[userId].some(m => m.groupMessageId === message.groupMessageId)) {
                                messagesPerUser[userId].push(message);
                            }
                        }
                    });
                }
            })
            .catch(error => {
                addLog(`ì‚¬ìš©ì ${userId}: ë©”ì‹œì§€ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`);

                if (updateUI) {
                    document.getElementById(`message-list-${userId}`).innerHTML = '';
                    messagesPerUser[userId] = [];
                }
            });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.onload = function() {
        initializeUserPanels();
        addLog("ë„¤ì´í‹°ë¸Œ WebSocketì„ ì‚¬ìš©í•©ë‹ˆë‹¤. SQLite ë½ ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ í•œ ë²ˆì— í•œ ì‚¬ìš©ìë§Œ ì—°ê²°í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.");
    };
</script>
</body>
</html>