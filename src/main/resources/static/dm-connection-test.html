<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ì—°ê²° ë° êµ¬ë… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }

        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .danger {
            background-color: #dc3545;
        }

        .danger:hover {
            background-color: #c82333;
        }

        .success {
            background-color: #28a745;
        }

        .success:hover {
            background-color: #218838;
        }

        #log {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .subscription-item {
            background-color: #e9ecef;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-item {
            background-color: #d1ecf1;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #bee5eb;
        }

        .message-time {
            font-size: 10px;
            color: #6c757d;
        }
    </style>
</head>
<body>
<h1>WebSocket ì—°ê²° ë° êµ¬ë… í…ŒìŠ¤íŠ¸</h1>

<div class="container">
    <!-- ì—°ê²° íŒ¨ë„ -->
    <div class="panel">
        <h2>ğŸ”— ì—°ê²° ì„¤ì •</h2>

        <div class="form-group">
            <label for="serverUrl">ì„œë²„ URL:</label>
            <input type="text" id="serverUrl" value="http://localhost:8080/ws" placeholder="http://localhost:8080/ws">
        </div>

        <div class="form-group">
            <label for="token">ì¸ì¦ í† í°:</label>
            <input type="password" id="token" placeholder="JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”">
        </div>

        <div class="form-group">
            <label for="userId">ì‚¬ìš©ì ID:</label>
            <input type="number" id="userId" value="1" placeholder="1">
        </div>

        <div id="connectionStatus" class="status disconnected">ì—°ê²° ì•ˆë¨</div>

        <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
    </div>

    <!-- êµ¬ë… íŒ¨ë„ -->
    <div class="panel">
        <h2>ğŸ“¡ êµ¬ë… ê´€ë¦¬</h2>

        <div class="form-group">
            <label for="subscriptionType">êµ¬ë… íƒ€ì…:</label>
            <select id="subscriptionType" onchange="updateDestination()">
                <option value="dm">DM</option>
                <option value="group">ê·¸ë£¹</option>
            </select>
        </div>

        <div class="form-group">
            <label for="chatRoomId">ì±„íŒ…ë°© ID:</label>
            <input type="number" id="chatRoomId" value="1" onchange="updateDestination()">
        </div>

        <div class="form-group">
            <label for="destination">êµ¬ë… ì£¼ì†Œ:</label>
            <input type="text" id="destination" value="/topic/dm/1" readonly>
        </div>

        <button id="subscribeBtn" onclick="subscribe()" disabled>êµ¬ë…</button>
        <button onclick="clearSubscriptions()" class="danger">ëª¨ë“  êµ¬ë… í•´ì œ</button>

        <div id="subscriptions">
            <h3>í™œì„± êµ¬ë…:</h3>
            <div id="subscriptionList"></div>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ì „ì†¡ íŒ¨ë„ -->
    <div class="panel">
        <h2>ğŸ“¤ ë©”ì‹œì§€ ì „ì†¡</h2>

        <div class="form-group">
            <label for="sendChatRoomId">ì±„íŒ…ë°© ID:</label>
            <input type="number" id="sendChatRoomId" value="1" onchange="updateSendDestination()">
        </div>

        <div class="form-group">
            <label for="sendDestination">ì „ì†¡ ì£¼ì†Œ:</label>
            <input type="text" id="sendDestination" value="/api/dm/1/send-message" readonly>
        </div>

        <div class="form-group">
            <label for="messageContent">ë©”ì‹œì§€ ë‚´ìš©:</label>
            <textarea id="messageContent" rows="3" placeholder="í…ŒìŠ¤íŠ¸ ë©”ì‹œì§€"></textarea>
        </div>

        <button id="sendBtn" onclick="sendMessage()" disabled>ë©”ì‹œì§€ ì „ì†¡</button>
    </div>

    <!-- ìˆ˜ì‹  ë©”ì‹œì§€ íŒ¨ë„ -->
    <div class="panel">
        <h2>ğŸ“¥ ìˆ˜ì‹  ë©”ì‹œì§€</h2>

        <button onclick="clearMessages()" class="danger">ë©”ì‹œì§€ ì´ˆê¸°í™”</button>

        <div id="messages">
            <div id="messageList"></div>
        </div>
    </div>

    <!-- ë¡œê·¸ íŒ¨ë„ -->
    <div class="panel full-width">
        <h2>ğŸ“‹ ë¡œê·¸</h2>
        <button onclick="clearLog()" class="danger">ë¡œê·¸ ì´ˆê¸°í™”</button>
        <div id="log"></div>
    </div>
</div>

<script>
    let stompClient = null;
    let subscriptions = new Map();

    function log(message) {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateConnectionStatus(connected) {
        const statusDiv = document.getElementById('connectionStatus');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const subscribeBtn = document.getElementById('subscribeBtn');
        const sendBtn = document.getElementById('sendBtn');

        if (connected) {
            statusDiv.textContent = 'ì—°ê²°ë¨';
            statusDiv.className = 'status connected';
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;
            subscribeBtn.disabled = false;
            sendBtn.disabled = false; // WebSocket ì—°ê²°ê³¼ ê´€ê³„ì—†ì´ HTTP ìš”ì²­ì€ ê°€ëŠ¥
        } else {
            statusDiv.textContent = 'ì—°ê²° ì•ˆë¨';
            statusDiv.className = 'status disconnected';
            connectBtn.disabled = false;
            disconnectBtn.disabled = true;
            subscribeBtn.disabled = true;
            sendBtn.disabled = false; // HTTP ìš”ì²­ì€ WebSocket ì—°ê²° ì—†ì´ë„ ê°€ëŠ¥
        }
    }

    function updateSendDestination() {
        const chatRoomId = document.getElementById('sendChatRoomId').value;
        const destination = `/api/dm/${chatRoomId}/send-message`;
        document.getElementById('sendDestination').value = destination;
    }

    function updateDestination() {
        const type = document.getElementById('subscriptionType').value;
        const chatRoomId = document.getElementById('chatRoomId').value;
        const destination = `/topic/${type}/${chatRoomId}`;
        document.getElementById('destination').value = destination;
    }

    function connect() {
        const serverUrl = document.getElementById('serverUrl').value;
        const token = document.getElementById('token').value;
        const userId = document.getElementById('userId').value;

        if (!token.trim()) {
            alert('ì¸ì¦ í† í°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        // í† í°ì„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
        const urlWithToken = `${serverUrl}?token=${encodeURIComponent(token)}`;

        log(`ì—°ê²° ì‹œë„: ${urlWithToken}`);

        const socket = new SockJS(urlWithToken);
        stompClient = Stomp.over(socket);

        // ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™”
        stompClient.debug = function(str) {
            log(`STOMP: ${str}`);
        };

        stompClient.connect({
            'user-id': userId,
            'Authorization': `Bearer ${token}`
        }, function(frame) {
            log('ì—°ê²° ì„±ê³µ: ' + frame);
            updateConnectionStatus(true);
        }, function(error) {
            log('ì—°ê²° ì‹¤íŒ¨: ' + error);
            updateConnectionStatus(false);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            // ëª¨ë“  êµ¬ë… í•´ì œ
            clearSubscriptions();

            stompClient.disconnect(function() {
                log('ì—°ê²° í•´ì œë¨');
                updateConnectionStatus(false);
            });
        }
    }

    function subscribe() {
        const destination = document.getElementById('destination').value;

        if (subscriptions.has(destination)) {
            log(`ì´ë¯¸ êµ¬ë… ì¤‘: ${destination}`);
            return;
        }

        const subscription = stompClient.subscribe(destination, function(message) {
            log(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${destination}`);
            displayMessage(destination, message.body);
        });

        subscriptions.set(destination, subscription);
        updateSubscriptionList();
        log(`êµ¬ë… ì‹œì‘: ${destination}`);
    }

    function unsubscribe(destination) {
        const subscription = subscriptions.get(destination);
        if (subscription) {
            subscription.unsubscribe();
            subscriptions.delete(destination);
            updateSubscriptionList();
            log(`êµ¬ë… í•´ì œ: ${destination}`);
        }
    }

    function clearSubscriptions() {
        subscriptions.forEach((subscription, destination) => {
            subscription.unsubscribe();
            log(`êµ¬ë… í•´ì œ: ${destination}`);
        });
        subscriptions.clear();
        updateSubscriptionList();
    }

    function updateSubscriptionList() {
        const listDiv = document.getElementById('subscriptionList');
        listDiv.innerHTML = '';

        if (subscriptions.size === 0) {
            listDiv.innerHTML = '<div style="color: #6c757d; font-style: italic;">êµ¬ë… ì—†ìŒ</div>';
            return;
        }

        subscriptions.forEach((subscription, destination) => {
            const item = document.createElement('div');
            item.className = 'subscription-item';
            item.innerHTML = `
                    <span>${destination}</span>
                    <button onclick="unsubscribe('${destination}')" class="danger" style="padding: 5px 10px; margin: 0;">í•´ì œ</button>
                `;
            listDiv.appendChild(item);
        });
    }

    function sendMessage() {
        const destination = document.getElementById('sendDestination').value;
        const content = document.getElementById('messageContent').value;
        const token = document.getElementById('token').value;

        if (!content.trim()) {
            alert('ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        if (!token.trim()) {
            alert('í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        const message = {
            content: content
        };

        // ì‹¤ì œ HTTP POST ìš”ì²­ ì „ì†¡
        fetch(destination, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(message)
        })
            .then(response => {
                if (response.ok) {
                    log(`ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ: ${destination} - ${content}`);
                    document.getElementById('messageContent').value = '';
                } else {
                    log(`ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
                }
                return response.text();
            })
            .then(responseText => {
                if (responseText) {
                    log(`ì„œë²„ ì‘ë‹µ: ${responseText}`);
                }
            })
            .catch(error => {
                log(`ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`);
            });
    }

    function displayMessage(destination, messageBody) {
        const messagesDiv = document.getElementById('messageList');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-item';

        const timestamp = new Date().toLocaleTimeString();

        try {
            const parsedMessage = JSON.parse(messageBody);
            messageDiv.innerHTML = `
                    <div><strong>ì±„ë„:</strong> ${destination}</div>
                    <div><strong>ë‚´ìš©:</strong> ${JSON.stringify(parsedMessage, null, 2)}</div>
                    <div class="message-time">${timestamp}</div>
                `;
        } catch (e) {
            messageDiv.innerHTML = `
                    <div><strong>ì±„ë„:</strong> ${destination}</div>
                    <div><strong>ë‚´ìš©:</strong> ${messageBody}</div>
                    <div class="message-time">${timestamp}</div>
                `;
        }

        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function clearMessages() {
        document.getElementById('messageList').innerHTML = '';
    }

    function clearLog() {
        document.getElementById('log').innerHTML = '';
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    window.addEventListener('beforeunload', function() {
        if (stompClient !== null) {
            disconnect();
        }
    });

    // ì´ˆê¸° destination ì„¤ì •
    updateDestination();
    updateSendDestination();
</script>
</body>
</html>